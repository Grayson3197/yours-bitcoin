<!DOCTYPE html><html lang="en"><head><title>txbuilder</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="txbuilder"><meta name="groc-project-path" content="lib/txbuilder.js"><meta name="groc-github-url" content="https://github.com/ryanxcharles/fullnode"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/ryanxcharles/fullnode/blob/master/lib/txbuilder.js">lib/txbuilder.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="transaction-builder">Transaction Builder</h1>
<p>Transaction Builder. This is a, yet unfinished, convenience class for
building pubkeyhash and p2sh transactions, and also for verifying arbitrary
transactions (and their inputs). You can (or will be able to) pay to
pubkeyhash to p2sh and can spend pubkeyhash or p2sh-pubkeyhash or
p2sh-multisig.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> Tx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./tx'</span>);
<span class="hljs-keyword">var</span> Txout = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./txout'</span>);
<span class="hljs-keyword">var</span> Address = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./address'</span>);
<span class="hljs-keyword">var</span> Script = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./script'</span>);
<span class="hljs-keyword">var</span> BN = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bn'</span>);
<span class="hljs-keyword">var</span> Block = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./block'</span>);
<span class="hljs-keyword">var</span> BufR = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bufr'</span>);
<span class="hljs-keyword">var</span> Interp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./interp'</span>);

<span class="hljs-keyword">var</span> Txbuilder = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Txbuilder</span><span class="hljs-params">(obj)</span> {</span>
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Txbuilder))
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Txbuilder(obj);
  <span class="hljs-keyword">if</span> (obj) {
    <span class="hljs-keyword">this</span>.initialize();
    <span class="hljs-keyword">this</span>.set(obj);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.initialize();
  }
};

module.exports = Txbuilder;

Txbuilder.prototype.initialize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">this</span>.tx = Tx();
  <span class="hljs-keyword">this</span>.prevtxoutsmap = {};
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Txbuilder.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
  <span class="hljs-keyword">this</span>.tx = obj.tx || <span class="hljs-keyword">this</span>.tx;
  <span class="hljs-keyword">this</span>.prevtxoutsmap = obj.prevtxoutsmap || <span class="hljs-keyword">this</span>.prevtxoutsmap;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Txbuilder.prototype.addToAddress = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(valuebn, addr)</span> {</span>
  <span class="hljs-keyword">if</span> (!(addr <span class="hljs-keyword">instanceof</span> Address) || !(valuebn <span class="hljs-keyword">instanceof</span> BN))
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'addr must be an Address, and valuebn must be a BN'</span>);
  <span class="hljs-keyword">if</span> (addr.type() === <span class="hljs-string">'scripthash'</span>) {
    <span class="hljs-keyword">var</span> script = Script().fromScripthash(addr.hashbuf);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (addr.type() === <span class="hljs-string">'pubkeyhash'</span>) {
    <span class="hljs-keyword">var</span> script = Script().fromPubkeyhash(addr.hashbuf);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'invalid address type'</span>);
  }
  <span class="hljs-keyword">var</span> txout = Txout(valuebn, script);
  <span class="hljs-keyword">this</span>.tx.addTxout(txout);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Verifies that the transaction is valid both by performing basic checks, such
as ensuring that no two inputs are the same, as well as by verifying every
script. The two checks are checktxstr, which is analagous to bitcoind&#39;s
CheckTransaction, and verifytxstr, which runs the script interpreter.</p>
<p>This does NOT check that any possible claimed fees are accurate; checking
that the fees are accurate requires checking that the input transactions are
valid, which is not performed by this test. That check is done with the
normal verify function.</p></div></div><div class="code"><div class="wrapper">Txbuilder.prototype.verifytx = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(flags)</span> {</span>
  <span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>.checktxstr() &amp;&amp; !<span class="hljs-keyword">this</span>.verifytxstr(flags);
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check that a transaction passes basic sanity tests. If not, return a string
describing the error. This function contains the same logic as
CheckTransaction in bitcoin core.</p></div></div><div class="code"><div class="wrapper">Txbuilder.prototype.checktxstr = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Basic checks that don&#39;t depend on any context</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tx.txins.length === <span class="hljs-number">0</span> || <span class="hljs-keyword">this</span>.tx.txinsvi.toNumber() === <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"transaction txins empty"</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tx.txouts.length === <span class="hljs-number">0</span> || <span class="hljs-keyword">this</span>.tx.txoutsvi.toNumber() === <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"transaction txouts empty"</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Size limits</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tx.toBuffer().length &gt; Block.MAX_BLOCK_SIZE)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"transaction over the maximum block size"</span>;
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check for negative or overflow output values</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> valueoutbn = BN(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.tx.txouts.length; i++) {
    <span class="hljs-keyword">var</span> txout = <span class="hljs-keyword">this</span>.tx.txouts[i];
    <span class="hljs-keyword">if</span> (txout.valuebn.lt(<span class="hljs-number">0</span>))
      <span class="hljs-keyword">return</span> <span class="hljs-string">"transaction txout "</span> + i + <span class="hljs-string">" negative"</span>;
    <span class="hljs-keyword">if</span> (txout.valuebn.gt(Tx.MAX_MONEY))
      <span class="hljs-keyword">return</span> <span class="hljs-string">"transaction txout "</span> + i + <span class="hljs-string">" greater than MAX_MONEY"</span>;
    valueoutbn = valueoutbn.add(txout.valuebn);
    <span class="hljs-keyword">if</span> (valueoutbn.gt(Tx.MAX_MONEY))
      <span class="hljs-keyword">return</span> <span class="hljs-string">"transaction txout "</span> + i + <span class="hljs-string">" total output greater than MAX_MONEY"</span>;
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check for duplicate inputs</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> txinmap = {};
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.tx.txins.length; i++) {
    <span class="hljs-keyword">var</span> txin = <span class="hljs-keyword">this</span>.tx.txins[i];
    <span class="hljs-keyword">var</span> inputid = txin.txhashbuf.toString(<span class="hljs-string">'hex'</span>) + <span class="hljs-string">':'</span> + txin.txoutnum;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> txinmap[inputid] !== <span class="hljs-string">'undefined'</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-string">"transaction input "</span> + i + <span class="hljs-string">" duplicate input"</span>;
    txinmap[inputid] = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tx.isCoinbase()) {
    <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">this</span>.tx.txins[<span class="hljs-number">0</span>].script.toBuffer();
    <span class="hljs-keyword">if</span> (buf.length &lt; <span class="hljs-number">2</span> || buf.length &gt; <span class="hljs-number">100</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-string">"coinbase trasaction script size invalid"</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.tx.txins.length; i++) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.tx.txins[i].hasNullInput())
        <span class="hljs-keyword">return</span> <span class="hljs-string">"tranasction input "</span> + i + <span class="hljs-string">" has null input"</span>;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>verify the transaction inputs by running the script interpreter. Returns a
string of the script interpreter is invalid, otherwise returns false.</p></div></div><div class="code"><div class="wrapper">Txbuilder.prototype.verifytxstr = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(flags)</span> {</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.tx.txins.length; i++) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.verifytxnin(i, flags))
      <span class="hljs-keyword">return</span> <span class="hljs-string">"input "</span> + i + <span class="hljs-string">" failed script verify"</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Verify a particular input by running the script interpreter. Returns true if
the input is valid, false otherwise.</p></div></div><div class="code"><div class="wrapper">Txbuilder.prototype.verifytxnin = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nin, flags)</span> {</span>
  <span class="hljs-keyword">var</span> txin = <span class="hljs-keyword">this</span>.tx.txins[nin];
  <span class="hljs-keyword">var</span> scriptSig = txin.script;
  <span class="hljs-keyword">var</span> txoutnum = txin.txoutnum;
  <span class="hljs-keyword">var</span> txidbuf = BufR(txin.txhashbuf).readReverse();
  <span class="hljs-keyword">var</span> txidhex = txidbuf.toString(<span class="hljs-string">'hex'</span>);
  <span class="hljs-keyword">var</span> mapid = txidhex + <span class="hljs-string">":"</span> + txoutnum;
  <span class="hljs-keyword">var</span> scriptPubkey = <span class="hljs-keyword">this</span>.prevtxoutsmap[mapid].script;
  <span class="hljs-keyword">var</span> interp = Interp()
  <span class="hljs-keyword">var</span> verified = interp.verify(scriptSig, scriptPubkey, <span class="hljs-keyword">this</span>.tx, nin, flags);
  <span class="hljs-keyword">return</span> verified;
};</div></div></div></div></body></html>