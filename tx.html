<!DOCTYPE html><html lang="en"><head><title>tx</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="tx"><meta name="groc-project-path" content="lib/tx.js"><meta name="groc-github-url" content="https://github.com/ryanxcharles/fullnode"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/ryanxcharles/fullnode/blob/master/lib/tx.js">lib/tx.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="transaction">Transaction</h1>
<p>A bitcoin transaction.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> Txin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./txin'</span>);
<span class="hljs-keyword">var</span> Txout = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./txout'</span>);
<span class="hljs-keyword">var</span> BufW = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bufw'</span>);
<span class="hljs-keyword">var</span> BufR = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bufr'</span>);
<span class="hljs-keyword">var</span> Varint = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./varint'</span>);
<span class="hljs-keyword">var</span> Hash = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./hash'</span>);
<span class="hljs-keyword">var</span> Script = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./script'</span>);
<span class="hljs-keyword">var</span> Sig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./sig'</span>);
<span class="hljs-keyword">var</span> BN = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bn'</span>);
<span class="hljs-keyword">var</span> ECDSA = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./ecdsa'</span>);

<span class="hljs-keyword">var</span> Tx = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Tx</span><span class="hljs-params">(version, txinsvi, txins, txoutsvi, txouts, nlocktime)</span> {</span>
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Tx))
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Tx(version, txinsvi, txins, txoutsvi, txouts, nlocktime);
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> version === <span class="hljs-string">'number'</span>) {
    <span class="hljs-keyword">this</span>.initialize();
    <span class="hljs-keyword">this</span>.set({
      version: version,
      txinsvi: txinsvi,
      txins: txins,
      txoutsvi: txoutsvi,
      txouts: txouts,
      nlocktime: nlocktime
    });
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Buffer.isBuffer(version)) {
    <span class="hljs-comment">//not necessary to initialize, since everything should be overwritten</span>
    <span class="hljs-keyword">var</span> txbuf = version;
    <span class="hljs-keyword">this</span>.fromBuffer(txbuf);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (version) {
    <span class="hljs-keyword">this</span>.initialize();
    <span class="hljs-keyword">var</span> obj = version;
    <span class="hljs-keyword">this</span>.set(obj);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">this</span>.initialize();
  }
};

Tx.MAX_MONEY = <span class="hljs-number">21000000</span> * <span class="hljs-number">1e8</span>;

Tx.prototype.initialize = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">this</span>.version = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">this</span>.txinsvi = Varint(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">this</span>.txins = [];
  <span class="hljs-keyword">this</span>.txoutsvi = Varint(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">this</span>.txouts = [];
  <span class="hljs-keyword">this</span>.nlocktime = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Tx.prototype.set = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
  <span class="hljs-keyword">this</span>.version = <span class="hljs-keyword">typeof</span> obj.version !== <span class="hljs-string">'undefined'</span> ? obj.version : <span class="hljs-keyword">this</span>.version;
  <span class="hljs-keyword">this</span>.txinsvi = obj.txinsvi || <span class="hljs-keyword">this</span>.txinsvi;
  <span class="hljs-keyword">this</span>.txins = obj.txins || <span class="hljs-keyword">this</span>.txins;
  <span class="hljs-keyword">this</span>.txoutsvi = obj.txoutsvi || <span class="hljs-keyword">this</span>.txoutsvi;
  <span class="hljs-keyword">this</span>.txouts = obj.txouts || <span class="hljs-keyword">this</span>.txouts;
  <span class="hljs-keyword">this</span>.nlocktime = <span class="hljs-keyword">typeof</span> obj.nlocktime !== <span class="hljs-string">'undefined'</span> ? obj.nlocktime : <span class="hljs-keyword">this</span>.nlocktime;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Tx.prototype.fromJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(json)</span> {</span>
  <span class="hljs-keyword">var</span> txins = [];
  json.txins.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txin)</span> {</span>
    txins.push(Txin().fromJSON(txin));
  });
  <span class="hljs-keyword">var</span> txouts = [];
  json.txouts.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txout)</span> {</span>
    txouts.push(Txout().fromJSON(txout));
  });
  <span class="hljs-keyword">this</span>.set({
    version: json.version,
    txinsvi: Varint().fromJSON(json.txinsvi),
    txins: txins,
    txoutsvi: Varint().fromJSON(json.txoutsvi),
    txouts: txouts,
    nlocktime: json.nlocktime
  });
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Tx.prototype.toJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> txins = [];
  <span class="hljs-keyword">this</span>.txins.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txin)</span> {</span>
    txins.push(txin.toJSON());
  });
  <span class="hljs-keyword">var</span> txouts = [];
  <span class="hljs-keyword">this</span>.txouts.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txout)</span> {</span>
    txouts.push(txout.toJSON());
  });
  <span class="hljs-keyword">return</span> {
    version: <span class="hljs-keyword">this</span>.version,
    txinsvi: <span class="hljs-keyword">this</span>.txinsvi.toJSON(),
    txins: txins,
    txoutsvi: <span class="hljs-keyword">this</span>.txoutsvi.toJSON(),
    txouts: txouts,
    nlocktime: <span class="hljs-keyword">this</span>.nlocktime
  };
};

Tx.prototype.fromBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(buf)</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fromBufR(BufR(buf));
};

Tx.prototype.fromBufR = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(br)</span> {</span>
  <span class="hljs-keyword">this</span>.version = br.readUInt32LE();
  <span class="hljs-keyword">this</span>.txinsvi = Varint(br.readVarintBuf());
  <span class="hljs-keyword">var</span> txinsnum = <span class="hljs-keyword">this</span>.txinsvi.toNumber();
  <span class="hljs-keyword">this</span>.txins = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; txinsnum; i++) {
    <span class="hljs-keyword">this</span>.txins.push(Txin().fromBufR(br));
  }
  <span class="hljs-keyword">this</span>.txoutsvi = Varint(br.readVarintBuf());
  <span class="hljs-keyword">var</span> txoutsnum = <span class="hljs-keyword">this</span>.txoutsvi.toNumber();
  <span class="hljs-keyword">this</span>.txouts = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; txoutsnum; i++) {
    <span class="hljs-keyword">this</span>.txouts.push(Txout().fromBufR(br));
  }
  <span class="hljs-keyword">this</span>.nlocktime = br.readUInt32LE();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Tx.prototype.toBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toBufW().concat();
};

Tx.prototype.toBufW = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bw)</span> {</span>
  <span class="hljs-keyword">if</span> (!bw)
    bw = <span class="hljs-keyword">new</span> BufW();
  bw.writeUInt32LE(<span class="hljs-keyword">this</span>.version);
  bw.write(<span class="hljs-keyword">this</span>.txinsvi.buf);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.txins.length; i++) {
    <span class="hljs-keyword">this</span>.txins[i].toBufW(bw);
  }
  bw.write(<span class="hljs-keyword">this</span>.txoutsvi.buf)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.txouts.length; i++) {
    <span class="hljs-keyword">this</span>.txouts[i].toBufW(bw);
  }
  bw.writeUInt32LE(<span class="hljs-keyword">this</span>.nlocktime);
  <span class="hljs-keyword">return</span> bw;
};

Tx.prototype.sighash = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(nhashtype, nin, subscript)</span> {</span>
  <span class="hljs-keyword">var</span> txcopy = Tx(<span class="hljs-keyword">this</span>.toBuffer());

  subscript = Script(subscript.toBuffer());
  subscript.removeCodeseparators();

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; txcopy.txins.length; i++) {
    txcopy.txins[i] = Txin(txcopy.txins[i].toBuffer()).setScript(Script(<span class="hljs-string">''</span>));
  }
  
  txcopy.txins[nin] = Txin(txcopy.txins[nin].toBuffer()).setScript(subscript);

  <span class="hljs-keyword">if</span> ((nhashtype &amp; <span class="hljs-number">31</span>) === Sig.SIGHASH_NONE) {
    txcopy.txouts.length = <span class="hljs-number">0</span>;
    txcopy.txoutsvi = Varint(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; txcopy.txins.length; i++) {
      <span class="hljs-keyword">if</span> (i !== nin)
        txcopy.txins[i].seqnum = <span class="hljs-number">0</span>;
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((nhashtype &amp; <span class="hljs-number">31</span>) === Sig.SIGHASH_SINGLE) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The SIGHASH_SINGLE bug.
<a href="https://bitcointalk.org/index.php?topic=260595.0">https://bitcointalk.org/index.php?topic=260595.0</a></p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (nin &gt; txcopy.txouts.length - <span class="hljs-number">1</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">'0000000000000000000000000000000000000000000000000000000000000001'</span>, <span class="hljs-string">'hex'</span>);

    txcopy.txouts.length = nin + <span class="hljs-number">1</span>;
    txcopy.txoutsvi = Varint(nin + <span class="hljs-number">1</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; txcopy.txouts.length; i++) {
      <span class="hljs-keyword">if</span> (i &lt; nin)
        txcopy.txouts[i] = Txout(BN().fromBuffer(<span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">'ffffffffffffffff'</span>, <span class="hljs-string">'hex'</span>)), Script(<span class="hljs-string">''</span>));
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; txcopy.txins.length; i++) {
      <span class="hljs-keyword">if</span> (i !== nin)
        txcopy.txins[i].seqnum = <span class="hljs-number">0</span>;
    }
  }
  <span class="hljs-comment">//else, SIGHASH_ALL</span>

  <span class="hljs-keyword">if</span> (nhashtype &amp; Sig.SIGHASH_ANYONECANPAY) {
    txcopy.txins[<span class="hljs-number">0</span>] = txcopy.txins[nin];
    txcopy.txins.length = <span class="hljs-number">1</span>;
    txcopy.txinsvi = Varint(<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">var</span> buf = BufW().write(txcopy.toBuffer()).writeInt32LE(nhashtype).concat();
  <span class="hljs-keyword">return</span> BufR(Hash.sha256sha256(buf)).readReverse();
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This function returns a signature but does not update any inputs</p></div></div><div class="code"><div class="wrapper">Tx.prototype.sign = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(keypair, nhashtype, nin, subscript)</span> {</span>
  <span class="hljs-keyword">var</span> hashbuf = <span class="hljs-keyword">this</span>.sighash(nhashtype, nin, subscript);
  <span class="hljs-keyword">var</span> sig = ECDSA.sign(hashbuf, keypair, <span class="hljs-string">'little'</span>).set({nhashtype: nhashtype});
  <span class="hljs-keyword">return</span> sig;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This function takes a signature as input and does not parse any inputs</p></div></div><div class="code"><div class="wrapper">Tx.prototype.verify = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sig, pubkey, nin, subscript)</span> {</span>
  <span class="hljs-keyword">var</span> hashbuf = <span class="hljs-keyword">this</span>.sighash(sig.nhashtype, nin, subscript);
  <span class="hljs-keyword">return</span> ECDSA.verify(hashbuf, sig, pubkey, <span class="hljs-string">'little'</span>);
};

Tx.prototype.hash = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> Hash.sha256sha256(<span class="hljs-keyword">this</span>.toBuffer());
};

Tx.prototype.id = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> BufR(<span class="hljs-keyword">this</span>.hash()).readReverse();
};

Tx.prototype.addTxin = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(txhashbuf, txoutnum, script, seqnum)</span> {</span>
  <span class="hljs-keyword">var</span> txin;
  <span class="hljs-keyword">if</span> (txhashbuf <span class="hljs-keyword">instanceof</span> Txin)
    txin = txhashbuf;
  <span class="hljs-keyword">else</span>
    txin = Txin(txhashbuf, txoutnum, script, seqnum);
  <span class="hljs-keyword">this</span>.txins.push(txin);
  <span class="hljs-keyword">this</span>.txinsvi = Varint(<span class="hljs-keyword">this</span>.txinsvi.toNumber() + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

Tx.prototype.addTxout = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(valuebn, script)</span> {</span>
  <span class="hljs-keyword">var</span> txout;
  <span class="hljs-keyword">if</span> (valuebn <span class="hljs-keyword">instanceof</span> Txout)
    txout = valuebn;
  <span class="hljs-keyword">else</span>
    txout = Txout(valuebn, script);
  <span class="hljs-keyword">this</span>.txouts.push(txout);
  <span class="hljs-keyword">this</span>.txoutsvi = Varint(<span class="hljs-keyword">this</span>.txoutsvi.toNumber() + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Analagous to bitcoind&#39;s IsCoinBase function in transaction.h</p></div></div><div class="code"><div class="wrapper">Tx.prototype.isCoinbase = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.txins.length === <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-keyword">this</span>.txins[<span class="hljs-number">0</span>].hasNullInput());
}

module.exports = Tx;</div></div></div></div></body></html>